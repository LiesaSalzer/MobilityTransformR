---
title: "mobilityTransformationR"
author: "Liesa Salzer"
output:
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{Description and usage of mobilityTransformationR}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
    %\VignettePackage{xcms}
    %\VignetteDepends{xcms,BiocStyle}
---

```{r style, echo = FALSE, results = 'asis', message=FALSE}
BiocStyle::markdown()
```

```{r, echo = FALSE, message = FALSE}
library(BiocStyle)
```

# Introduction

XXX Add Despription of need of mobility transformation + Ref Drouin et al. 


# Setup

## Load required libries
<code>mobilityTransformationR</code> integrates functions from different libraries.

```{r libraries, message=FALSE, warning=FALSE}
# installation of additional packages
devtools::install_github("LiesaSalzer/mobilityTransformationR") 

# load required libraries
library(xcms)
library(mobilityTransformationR)
library(Spectra)
```


## Load test data
The test data contains a CE-MS data set acquired in positive CE polarity and positive ionization mode. The analyzed sample contains several metabolites at 10 ppm concentration and additionally paracetamol as EOF marker and procaine as positively charged marker, which will be used for effective mobility scale transformation.

```{r data, message=FALSE}
fl <- system.file("extdata/CEMS_metabolites_10ppm_pos_centroidedData.mzML", package = "mobilityTransformationR")

# Load mzXML data with MSnBase
raw_data <- readMSData(files = fl,
                       mode = "onDisk")
```

# Determine marker migration times

## EOF marker paracetamol
Plot marker within mz-tolerance and in mt-range. Check if the marker is present + minimum intensity <code>minInt</code> using plot functions from <code>MSnbase</code>. 
Note that the plot functions are adapted from LC-MS package MSnbase, why the x axis is named "retention time" which corresponds for CE data to "migration time". 
```{r EOF marker, message=FALSE}
# mz tolerance dependent of MS mass accuracy 
tolerance <- 0.005

mz_paracetamol <- c(152.071154 - tolerance, 152.071154 + tolerance)
mt_paracetamol <- c(600, 1500)

marker <-  raw_data %>% filterMz(mz = mz_paracetamol) %>% filterRt(rt = mt_paracetamol)
plot(chromatogram(marker))

#adjust the mt and mz window if necessary
mt_paracetamol <- c(700, 1000)

paracetamol <- getMt(raw_data,
                        mz = mz_paracetamol, 
                        mt = mt_paracetamol, 
                        minInt = 5000)

```

## Secondary marker procaine
```{r charged marker, message=FALSE}
mz_procaine <- c(237.160303 - tolerance, 237.160303 + tolerance)
mt_procaine <- c(600, 1500)

marker <-  raw_data %>% filterMz(mz = mz_procaine) %>% filterRt(rt = mt_procaine)
plot(chromatogram(marker))

#adjust the mt and mz window if necessary
mt_procaine <- c(300, 800)
marker <-  raw_data %>% filterMz(mz = mz_procaine) %>% filterRt(rt = mt_procaine)
plot(chromatogram(marker))

procaine <- getMt(raw_data,
                        mz = mz_procaine, 
                        mt = mt_procaine, 
                        minInt = 5000)

```

# Effective mobility scale transformation

## Effective mobility calculation of the secondary marker
First, the effective mobility of the secondary mobility marker is calculated.
If a single migration time, as here shown for Procaine, needs to be changed into effective mobility, the <code>mobilityTransform</code> function can be applied by using the mt (<code>tM</code>) as input. 
The transformation is performed using the mt of the EOF marker <code>tEOF</code> paracetamol, the field ramping time <code>tR</code> (in sec), the applied voltage <code>U</code> in kV, and the total and effective capillary length <code>L</code> and <code>l</code> in mm.
```{r mobility, message=FALSE}

procaineMobility <- mobilityTransform(tM = procaine, type = "singleMarker", 
                                      tEOF = paracetamol, tR = 3, 
                                      U = +30, L = 800, l = 800)

```

In order to perform the effective mobility scale transformation on whole CE-MS data sets, the data must be loaded as <code>Spectra</code> Object. Here, the migration time scale can be manipulated and transformed into the desired effective mobility scale. 

```{r spectra, message=FALSE}
#load the test data as spectra object
spectra_data <- Spectra(fl, backend = MsBackendMzR())
```

The migration time of the <code>Spectra</code> object easily might be transformed into the mobility scale using the <code>mobilityTransform</code> function. Either a single marker or two markers can be used for effective mobility scale transformation.
Note that if a charged single marker is used for transformation additionally its effective mobility must be provided. 
Here, we apply the effective mobility transformation using two markers, Paracetamol as EOF marker and Procaine as charged secondary marker. 

```{r mobility transformation, message=FALSE}
#load the test data as spectra object
spectra_data$rtime <- mobilityTransform(tM = spectra_data$rtime, 
                                   type = "twoMarker",
                                   tEOF = paracetamol,
                                   tA = procaine, 
                                   tR = 3, 
                                   mobilityA = procaineMobility
                                   )

#Data needs to be ordered by the migration time and spectrum IDs needs to 
#be removed to prevent errors in xcms peak picking processes
spectra_data <- spectra_data[order(rtime(spectra_data))]
spectra_data$spectrumId <- NA

#Transformed data can then be exported again as .mzML file to use in xcms or other software
fl_mobility <- tempfile()
export(applyProcessing(spectra_data), MsBackendMzR(), file = fl_mobility)
```

# Inspect effective mobility transformed data 
The transformed data can be loaded and analyzed with xcms. Note that the x-axis label "retention time" still corresponds to LC-MS data and is not true for the transformed CE-MS data. The x-axis of the transformed CE-MS data corresponds to the effective mobility in mm^2 / (kV * min).
The same functions of xcms can be now applied for the transformed data, but care must be taken that e.g. when filter for effective mobility the function <code>filterRT</code> is used.
```{r mobility transformed data, message=FALSE}
#load the transformed test data with MSnbase
mobility_data <- readMSData(files = fl_mobility, mode = "onDisk")

mz_lysine <- c(147.112806 - tolerance, 147.112806 + tolerance)
mobilityRestriction <- c(-100,5000)

# Extract ion electropherogram of compound
lysine_mobility <-  mobility_data %>% filterMz(mz = mz_lysine) %>% filterRt(rt = mobilityRestriction)
plot(chromatogram(lysine_mobility))

# compare with extracted ion electropherogram of migration time scale
lysine_mt <-  raw_data %>% filterMz(mz = mz_lysine)# %>% filterRt(rt = c(0))
plot(chromatogram(lysine_mt))

```



