---
title: "Description and usage of mobilityTransformationR"
output:
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{Description and usage of mobilityTransformationR}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
    %\VignettePackage{mobilityTransformationR}
    %\VignetteDepends{mobilityTransformationR,xcms,BiocStyle}
bibliography: references.bib
csl: biomed-central.csl
---

```{r style, echo = FALSE, results = 'asis', message=FALSE}
BiocStyle::markdown()
```

**Package**: `mobilityTransformationR`<br />
**Authors**: `r packageDescription("mobilityTransformationR")[["Author"]] `<br />
**Last modified:** `r file.info("mobilityTransformationR.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r, echo = FALSE, message = FALSE}
library(BiocStyle)
```

# Introduction

Capillary elecrophoresis coupled to mass spectrometry (CE-MS) in fields as proteomics or metabolomics is less common than for example liquid chromatography-mass spectrometry (LC-MS). A reason might be less reproducible migration times (MT) compared to retention times (RT) because of fluctuations in the Electroosmotic flow (EOF). 

However, the effective mobility $µ_{eff}$ of a compound remains stable in the same electrophoretic system. The use of an effective mobility scale instead of a migration time scale circumvents this drawback and will result in highly reproducible peaks, which has already been shown in 2001 @Schmitt-Kopplin2001. 

Effective mobility transformation for CE-MS data is not as straightforward as in CE-UV and until now and to our knowledge there is no implementation in R that performs the effective mobility transformation of CE-MS(/MS) data. 

As a model for the <code>mobilityTransformationR</code> package, we have taken the functions from the recently developed ROMANCE software @ROMANCE2018. ROMANCE is an open-source software that transforms the MT scale of CE-MS data into an $µ_{eff}$ scale. 
However, the output are two separate files for positive and negative mobilities. Moreover it is only suitable for MS1 data, because the MS2 information will get lost after transformation. 

MS2 data is crucial to improve annotation success in e.g. non-targeted metabolomics, where it will be used for spectral library matching. Therefore, we developed the <code>mobilityTransformationR</code> package, which will cover the mobility transformation of CE-MS/MS data. Also, different to ROMANCE, there will be only a single file containing the effective mobilities, the positive and negative ones. 

The transformation is performed using some base functions of <code>xcms</code>, <code>MSnbase</code>, and <code>Spectra</code>. The transformed data can be exported as <code>.mzML</code> file and can be further analyzed in R or other software.




# Setup

## Installation
The <code>mobilityTransformationR</code> package can be installed directly from GitHub using <code>devtools::install_github("LiesaSalzer/mobilityTransformationR")</code> 

## Load required libries
<code>mobilityTransformationR</code> integrates functions from different libraries.

```{r libraries, message=FALSE, warning=FALSE}
# load required libraries
library(mobilityTransformationR)
library(xcms)
library(Spectra)
```


## Load test data

To showcase the functionalities of the <code>mobilityTransformationR</code> package a CE-MS test set containing a mixture of 10 different metabolites at 10 ppm concentration, acquired at positive CE polarity and positive ionization mode is used. Moreover, Paracetamol was added as EOF marker in a final concentration of 50 ppm to the sample. Moreover, Procaine was added as positive charged, and ethyl sulfate as negatively charged secondary marker, both at a final concentration of 10 ppm. 
The markers are required for the later effective mobility transformation process. 

The test data is loaded using the <code>readMSData()</code> function from <code>MSnbase</code>.

```{r data, message=FALSE}
fl <- system.file("extdata/CEMS_metabolites_10ppm_pos_centroidedData.mzML", 
                  package = "mobilityTransformationR")

# Load mzXML data with MSnBase
raw_data <- readMSData(files = fl, mode = "onDisk")
```

# Get Marker Migration Times
In order to perform the effective mobility transformation, first the migration times (MT) of the markers needs to be determined. If multiple files are analyzed the MT of the markers in each file must be determined since they will not be the same because of the EOF fluctuations. 

The <code>getMt()</code> function requires the <code>raw_data</code> as input and uses an mz-range <code>mz</code> and MT-range <code>mt</code> to generate and Extracted Ion Electropherogram (EIE). The MT with the highest intensity above the defined threshold <code>minInt</code> in this EIE will be returned.

Therefore, it is very important to define the <code>mz</code>-range and <code>mt</code>-range as narrow as possible to ensure that the right peak will be picked. The mz-tolerance defining the <code>mz</code>-range depends on the mass accuracy of the mass spectrometer that was used to acquire the data.

## Get MT of EOF Marker Paracetamol

In order to check the right <code>mz</code>-, and <code>mt</code>-window and <code>minInt</code> for the exact MT determination, check the data with the <code>plot(chromatogram())</code> function using the respective EIE. 

Note that the plot functions are adapted from LC-MS package MSnbase, which has "retention time" on the x-axis label. 

```{r EOF marker, message=FALSE}
# mz tolerance depends on MS mass accuracy 
tolerance <- 0.005

# [M+H]+ of paracetamol: mz = 152.071154
mz_paracetamol <- c(152.071154 - tolerance, 152.071154 + tolerance)
mt_paracetamol <- c(600, 1500)

marker_EIE <-  raw_data %>% filterMz(mz = mz_paracetamol) %>% 
    filterRt(rt = mt_paracetamol)

plot(chromatogram(marker_EIE), 
     main = "Paracetamol EIE", 
     xlab = "migration time (sec)")

# adjust mz and MT windows if necessary
```

Use the adapted values to get the exact MT of Paracetamol. 
If several files will be used it is important to select a <code>mt</code>-range wide enough to get the right Paracetamol-peaks in all files, because single migration times might change a lot due to EOF-fluctuations between measurements. 
```{r EOF marker getMT, message=FALSE}
# get the MT of paracetamol
paracetamol <- getMt(raw_data,
                        mz = mz_paracetamol, 
                        mt = mt_paracetamol, 
                        minInt = 5000)
paracetamol

```

## Get MT of Secondary Marker Procaine
Effective mobilities can be already calculated using the EOF marker Paracetamol. However, it is also possible to calculate the mobility using another marker. This might be of interest for example when the peak shape of the main marker is not sufficient or ambiguity detection.

For such reasons procaine was added to the mixture as positively charged secondary marker. 

```{r charged marker, message=FALSE}
mz_procaine <- c(237.160303 - tolerance, 237.160303 + tolerance)
mt_procaine <- c(600, 1500)

marker_EIE <-  raw_data %>% filterMz(mz = mz_procaine) %>%
    filterRt(rt = mt_procaine)

plot(chromatogram(marker_EIE), 
     main = "Procaine EIE",
     xlab = "migration time (sec)")
```

It can be seen that within this mz-window and MT-window no peak is present. If a <code>minInt</code> threshold of for example <code>5000</code> is used, no MT will be provided by <code>getMt()</code>. However, if a limit is accidentally selected that is too small, noise will be picked and a MT is returned that is incorrect. 

```{r charged marker getMt, message=FALSE}
#adjust the mt and mz window if necessary
mt_procaine <- c(300, 800)

marker_EIE <-  raw_data %>% filterMz(mz = mz_procaine) %>% 
    filterRt(rt = mt_procaine)

plot(chromatogram(marker_EIE), 
     main = "Procaine EIE",
     xlab = "migration time (sec)")

# get the MT of procaine using adjusted parameters
procaine <- getMt(raw_data,
                        mz = mz_procaine, 
                        mt = mt_procaine, 
                        minInt = 5000)

procaine
```


# Effective mobility scale transformation

Effective mobility scale transformation is performed either by using a single or two mobility markers. Functions were adapted from González-Ruiz et al. @ROMANCE2018 . 
The standard equation to calculate effective mobility $µ_{eff}$ is 

\begin{equation}
      µ_{eff} = \frac{l}{E} (\frac{1}{t_M - (t_R/2)} - \frac{1}{t_{EOF} - (t_R/2)}) 
  (\#eq:mobility1)
\end{equation}
with $t_M$ the migration time that is transformed, $t_{EOF}$ the MT of the EOF marker and optional $t_R$ which is the time of the electrical field ramp.

If the peak shape of the EOF marker is bad or it cannot be detected for other reasons, the effective mobility might also be calculated using a secondary mobility marker with known mobility: 

\begin{equation}
      µ_{eff} = µ_A + \frac{l}{E} (\frac{1}{t_M - (t_R/2)} - \frac{1}{t_A - (t_R/2)}) 
  (\#eq:mobility2)
\end{equation}
with $t_A$, the MT of the secondary marker and its corresponding mobility $µ_A$. 

Last, the mobility might be calculated using both markers. Therefore, there is no need to know the applied electrical field nor the exact capillary length. 

\begin{equation}
      µ_{eff} = µ_A \frac{t_M - t_{EOF}}{t_A - t_{EOF}} * \frac{t_A - (t_R/2)}{t_M - (t_R/2)} 
  (\#eq:mobility3)
\end{equation}



## Calculation of the Secondary Marker Mobility $µ_A$ 
First, the effective mobility of the secondary mobility marker (Procaine) is calculated according to eq. \@ref(eq:mobility1).


```{r mobility, message=FALSE}

procaineMobility <- mobilityTransform(tM = procaine, type = "singleMarker", 
                                      tEOF = paracetamol, tR = 3, 
                                      U = +30, L = 800, l = 800)
procaineMobility

```
Note: The unit of the mobility is $\frac{mm^2}{kV*min}$

## Effective Mobility Scale Transformation on Whole CE-MS Datasets 
In order to perform the effective mobility scale transformation on whole CE-MS data sets, the data must be loaded as <code>Spectra</code> Object. Here, the migration time scale can be manipulated and transformed into the desired effective mobility scale. 

```{r spectra, message=FALSE}
#load the test data as spectra object
spectra_data <- Spectra(fl, backend = MsBackendMzR())
```

The MT-scale of the <code>Spectra</code> object is transformed into the mobility scale using the <code>mobilityTransform</code> function. Either a single marker or two markers can be used for effective mobility scale transformation.
Note that if a charged single marker is used for transformation additionally its effective mobility must be provided. 

Here, we apply the effective mobility transformation using two markers according to eq. \@ref(eq:mobility3), Paracetamol as EOF marker and Procaine as charged secondary marker. 

```{r mobility transformation, message=FALSE}
#load the test data as spectra object
spectra_data$rtime <- mobilityTransform(tM = spectra_data$rtime, 
                                   type = "twoMarker",
                                   tEOF = paracetamol,
                                   tA = procaine, 
                                   tR = 3, 
                                   mobilityA = procaineMobility
                                   )
```
Now the MT-scale of <code>spectra_data</code> was transformed into the desired mobility scale. Note that the effective mobility values are still stored in  <code>spectra_data$rtime</code>. 

In order to be able to further process and analyze the transformed CE-MS(/MS) data with e.g.  <code>xcms</code> it is necessary to order the established effective mobilities and remove <code>spectrumID</code>s to prevent errors. 
After that, <code>spectra_data</code> is exported as <code>.mzML</code> file and is ready for data analysis using <code>xcms</code> or other softwares and packages.

```{r remove spectrumID, message=FALSE}
#Data needs to be ordered by the mobilites and spectrum IDs needs to 
#be removed to prevent errors in xcms peak picking processes
spectra_data <- spectra_data[order(rtime(spectra_data))]
spectra_data$spectrumId <- NA

#Transformed data can then be exported again as .mzML file to use in xcms or other software
fl_mobility <- tempfile()
export(applyProcessing(spectra_data), MsBackendMzR(), file = fl_mobility)
```

# Inspect and Analyze the Transformed Data 
At last, we load the transformed data with <code>MSnbase</code> and inspect them with the <code>plot(chromatogram())</code> function from <code>xcms</code>. 
The same functions can be now applied to the transformed data as for raw data. Care must be taken at the labeling since it remains "retention time" (or "RT") even if the scale is now in mobility units $\frac{mm^2}{kV*min}$.

As described before, the analyzed data contain 10 different metabolites in 10 ppm concentration acquired in positive ionization mode. We can check the effective mobilities of single compounds by extracting their EIE as for example Lysine (mz = 147.112806).

```{r mobility transformed data, message=FALSE}
#load the transformed test data with MSnbase
mobility_data <- readMSData(files = fl_mobility, mode = "onDisk")

mz_lysine <- c(147.112806 - tolerance, 147.112806 + tolerance)
mobilityRestriction <- c(-100,5000)

# Extract ion electropherogram of compound
lysine_µ_EIE <-  mobility_data %>% 
    filterMz(mz = mz_lysine) %>% 
    filterRt(rt = mobilityRestriction)

plot(chromatogram(lysine_µ_EIE), 
     main = expression(paste("Lysine EIE - µ"[eff]," scale")), 
     xlab = expression(paste("µ"[eff],"  (", frac("mm"^2,"kV min"),")"))
     )

# compare with extracted ion electropherogram of migration time scale
lysine_mt_EIE <-  raw_data %>% 
    filterMz(mz = mz_lysine)

plot(chromatogram(lysine_mt_EIE),
     main = "Lysine EIE - MT scale", 
     xlab = "MT (sec)")

```

# Session information

```{r si}
sessionInfo()
```


# References



