---
title: "MobilityTransformationR"
author: "Liesa Salzer"
output:
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{Description and usage of MobilityTransformationR}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
    %\VignettePackage{xcms}
    %\VignetteDepends{xcms,BiocStyle}
---

```{r style, echo = FALSE, results = 'asis', message=FALSE}
BiocStyle::markdown()
```

```{r, echo = FALSE, message = FALSE}
library(BiocStyle)
```

# Introduction

XXX Add Despription of need of mobility transformation + Ref Drouin et al. 


# Setup

## Load required libries
<code>mobilityTransformationR</code> integrates functions from different libraries.

```{r libraries, message=FALSE, warning=FALSE}
# installation of additional packages
devtools::install_github("LiesaSalzer/mobilityTransformationR", ref = "devel") 

# load required libraries
library(xcms)
library(mobilityTransformationR)
library(Spectra)
```


## Load test data
The test data contains a CE-MS data set acquired in positive CE polarity and positive ionization mode. The analyzed sample contains several metabolites at 10 ppm concentration and additionally paracetamol as EOF marker and procaine as positively charged marker, which will be used for effective mobility scale transformation.

```{r data, message=FALSE}
fl <- system.file("extdata/CEMS_metabolites_10ppm_pos_centroidedData.mzML", package = "mobilityTransformationR")

# Load mzXML data with MSnBase
raw_data <- readMSData(files = fl,
                       mode = "onDisk")
```

# Determine marker migration times

## EOF marker paracetamol
Plot marker within mz-tolerance and in mt-range. Check if the marker is present + minimum intensity <code>minInt</code> using plot functions from <code>MSnbase</code>. 
Note that the plot functions are adapted from LC-MS package MSnbase, why the x axis is named "retention time" which corresponds for CE data to "migration time". 
```{r EOF marker, message=FALSE}
# mz tolerance dependent of MS mass accuracy 
tolerance <- 0.005

mz_paracetamol <- c(152.071154 - tolerance, 152.071154 + tolerance)
mt_paracetamol <- c(600, 1500)

marker <-  raw_data %>% filterMz(mz = mz_paracetamol) %>% filterRt(rt = mt_paracetamol)
plot(chromatogram(marker))

#adjust the mt and mz window if necessary
mt_paracetamol <- c(700, 1000)

paracetamol <- getMtime(raw_data,
                        mz = mz_paracetamol, 
                        mt = mt_paracetamol, 
                        minInt = 5000)

```

## Secondary marker procaine
```{r charged marker, message=FALSE}
mz_procaine <- c(237.160303 - tolerance, 237.160303 + tolerance)
mt_procaine <- c(600, 1500)

marker <-  raw_data %>% filterMz(mz = mz_procaine) %>% filterRt(rt = mt_procaine)
plot(chromatogram(marker))

#adjust the mt and mz window if necessary
mt_procaine <- c(300, 800)
marker <-  raw_data %>% filterMz(mz = mz_procaine) %>% filterRt(rt = mt_procaine)
plot(chromatogram(marker))

procaine <- getMtime(raw_data,
                        mz = mz_procaine, 
                        mt = mt_procaine, 
                        minInt = 5000)

```

# Effective mobility scale transformation
<code>mobilityTransform</code> uses different functions to perform the effective
mobility transformation depending on the input type. It is possible to convert
<code>numeric</code>, <code>Spectra</code>, and <code>OnDiskMSnExp</code>. 
Here, we show how each input can be transformed perform the transformation.

## Effective mobility transformation of the single migration times
First, a <code>data.frame</code> is created that stores the marker information, 
that will be used to transform the data. Either one or two markers can be used 
for the transformation. The <code>data.frame</code> needs at least the columns
<code>rtime</code> and <code>mobility</code>. Additional columns to store marker 
information might be added as well.
Here, we start with the neutral EOF marker Paracetamol, having the effective 
mobility of 0 mm^2 / (kV * min).

```{r, message=FALSE}
# Create a data.frame that stores marker information
marker <- data.frame(markerID = "Paracetamol",
                       rtime = paracetamol,
                       mobility = 0)
```


Then the effective mobility of the secondary mobility marker Procaine, as single 
migration time, is determined.
The transformation is performed using the marker information from Paracetamol. 
Moreover, if only a single marker is provided for the transformation, also the 
applied voltage <code>U</code> in kV, and the total and effective capillary 
length <code>L</code> in mm is needed. 
Additionally the field ramping time <code>tR</code> (in sec) can be included for
corrections. 

```{r mobility, message=FALSE}
procaineMobility <- mobilityTransform(x = procaine, marker = marker, 
                                      tR = 3, U = +30, L = 800)
```

## Effective mobility transformation of whole CE-MS runs

<code>mobilityTransform</code> can also be applied to whole CE-MS runs stored either as <code>Spectra</code>-object or <code>OnDiskMSnExp</code>-object.
As shown as before, either a single or two markers can be used for conversion. 
Here, we add the marker information of Procaine to the marker <code>data.frame</code>, so the transformation is done based on both markers.

```{r, message=FALSE}
marker <- rbind(marker, 
                data.frame(markerID = "Procaine",
                       rtime = procaine,
                       mobility = procaineMobility))
```

### Effective mobility transformation of OnDiskMSnExp objects
The migration time scale of <code>raw_data</code> is transformed and the same class will be returned.
```{r, message=FALSE}
# Conversion of mt in OnDiskMSnExp objects
mobility_data <- mobilityTransform(x = raw_data, marker = marker)
    
```

### Effective mobility transformation of Spectra objects
<code>Spectra</code>-objects can be transformed similarly in <code>mobilityTransform</code>. The resulting <code>Spectra</code>-objects can then also be exported as <code>.mzML</code> for further processing in different software.
```{r, message=FALSE}
#load the test data as spectra object
spectra_data <- Spectra(fl, backend = MsBackendMzR())

spectra_mobility <- mobilityTransform(spectra_data, marker)

#Transformed data can then be exported again as .mzML file to use in xcms or other software
fl_mobility <- tempfile()
export(applyProcessing(spectra_data), MsBackendMzR(), file = fl_mobility)

```


# Inspect effective mobility transformed data 
The transformed data can displayed and further analyzed with  e.g. <code>xcms</code>. Note that the effective mobility can be accessed by e.g. <code>spectra_mobility$rtime</code>, since functions where adapted from LC-MS based <code>rformassspectrometry</code> functions.
The resulting unit of the effective mobility is mm^2 / (kV * min).

```{r mobility transformed data, message=FALSE}
# Example: Extract ion electropherogram (EIE) from lysine
mz_lysine <- c(147.112806 - tolerance, 147.112806 + tolerance)
mobilityRestriction <- c(-100,5000)

# EIE of lysine (mobility scale)
lysine_mobility <-  mobility_data %>% filterMz(mz = mz_lysine) %>% filterRt(rt = mobilityRestriction)
plot(chromatogram(lysine_mobility), xlab = "effective mobility")

# compare with EIE of lysine in mt-scale
lysine_mt <-  raw_data %>% filterMz(mz = mz_lysine)# %>% filterRt(rt = c(0))
plot(chromatogram(lysine_mt), xlab = "migration time")

```



